---
title: "Schulnoten in Pankow und Lichtenberg"
html_document:
    css: ["styles.css"] 
---

```{r, warning=FALSE, message=FALSE, echo=FALSE, out.width="100%"}
library(tidyverse)
library(httr)
library(sf)
library(leaflet)
library(leaflet.extras)
library(htmltools)

# Read in data ------------------------------------------------------------

source("get_data.R")
pankow <- get_school_grades_pankow() %>%
  rename(note_pankow = note) %>%
  mutate(schuljahr = "2023")

# Add Pankow 2024 data
pankow_2024 <- get_school_grades_pankow_2024() %>%
  mutate(note = ifelse(note == "alle", "ohne Note", note)) %>%
  mutate(note = ifelse(note == "**", "ohne Note", note))

# Combine all Lichtenberg data (historical + 2025)
# Combine all Lichtenberg data (historical + 2025)
lichtenberg_historical <- tryCatch({
  get_school_grades_lichtenberg() %>% 
    mutate(note = ifelse(is.na(note), "ohne Note", as.character(note)))
}, warning = function(w) {
  message("No historical Lichtenberg data available, using 2025 data only")
  tibble(name = character(), note = character(), schuljahr = character())
}, error = function(e) {
  message("Error loading historical Lichtenberg data:", e$message)
  tibble(name = character(), note = character(), schuljahr = character())
})

lichtenberg_2025 <- get_school_grades_lichtenberg_2025()

# Combine data - this will work even if historical data is empty
lichtenberg_all <- bind_rows(lichtenberg_historical, lichtenberg_2025) %>% 
  mutate(note = ifelse(is.na(note), "ohne Note", as.character(note)))
schulen <- get_school_mapdata() %>%
  rename(lon = X, lat = Y) %>%
  filter(schultyp %in% c("Integrierte Sekundarschule", "Gymnasium")) %>%
  mutate(name = str_remove(name, pattern =" \\(Integrierte Sekundarschule\\)")) %>%
  mutate(name = str_remove(name, pattern =" \\(Gemeinschaftsschule\\)")) %>%
  mutate(name = str_remove(name, pattern ="-Schule")) %>%
  mutate(name = str_remove(name, pattern ="-Gemeinschaftsschule")) %>%
  mutate(name = str_remove(name, pattern ="-Gymnasium"))


# Join datasets -----------------------------------------------------------

# First, aggregate multi-year data into formatted strings per school
lichtenberg_summary <- lichtenberg_all %>%
  arrange(name, schuljahr) %>%
  group_by(name) %>%
  summarise(
    note_years = paste(schuljahr, ":", note, collapse = " | "),
    latest_note = last(note),
    .groups = "drop"
  )

# Combine Pankow data (2023 + 2024)
pankow_all <- bind_rows(
  pankow %>% rename(note = note_pankow) %>% mutate(schuljahr = as.character(schuljahr)),
  pankow_2024 %>% mutate(schuljahr = as.character(schuljahr))
) %>% 
  mutate(note = ifelse(is.na(note), "ohne Note", as.character(note)))

pankow_summary <- pankow_all %>%
  arrange(name, schuljahr) %>%
  group_by(name) %>%
  summarise(
    note_years = paste(schuljahr, ":", note, collapse = " | "),
    latest_note = last(note),
    .groups = "drop"
  )

df <- schulen %>%
  filter(bezirk == "Pankow" | bezirk == "Lichtenberg") %>%
  select(name, schultyp, bezirk, website, lon, lat) %>%
  left_join(lichtenberg_summary, by = join_by(name)) %>%
  rename(note_years_lichtenberg = note_years, latest_note_lichtenberg = latest_note) %>%
  left_join(pankow_summary, by = join_by(name)) %>%
  rename(note_years_pankow = note_years, latest_note_pankow = latest_note) %>%
  mutate(note_years = ifelse(bezirk == "Pankow", note_years_pankow, note_years_lichtenberg)) %>%
  mutate(latest_note = ifelse(bezirk == "Pankow", latest_note_pankow, latest_note_lichtenberg)) %>%
  mutate(gruppe = "note-vorhanden") %>%
  mutate(gruppe = ifelse(latest_note == "ohne Note", "ohne-note", gruppe)) %>%
  mutate(gruppe = ifelse(is.na(latest_note), "keine-daten", gruppe)) %>%
  mutate(note_years = ifelse(is.na(note_years), "keine Daten", note_years))



# Setup leaflet -----------------------------------------------------------


pal <- colorFactor(c('black', 'darkred', 'darkgreen'),
                   domain =c("note-vorhanden", "ohne-note", "keine-daten"))



# Start leaflet -----------------------------------------------------------

# Create enhanced labels with HTML
create_label <- function(name, website, note_years) {
  label_parts <- c(paste0("<b>", name, "</b>"))

  if (!is.na(website) && website != "") {
    label_parts <- c(label_parts, paste0('<a href="', website, '" target="_blank">Website</a>'))
  }

  label_parts <- c(label_parts, paste0("Noten: ", note_years))

  htmltools::HTML(paste(label_parts, collapse = "<br/>"))
}

# Apply labels to each school
df <- df %>%
  rowwise() %>%
  mutate(popup_label = list(create_label(name, website, note_years))) %>%
  ungroup()

# Output the map and legend separately
# First, create and display the map
map_output <- 
  leaflet(options = leafletOptions(
    zoomControl = TRUE,
    attributionControl = TRUE,
    preferCanvas = TRUE
  )) %>%
    addTiles() %>%
    setView(lng = 13.48, lat = 52.56, zoom = 12) %>%
    addCircleMarkers(
      lng = df$lon,
      lat = df$lat,
      color = pal(df$gruppe),
      radius = 8,
      popup = df$popup_label,
      label = df$name,
      labelOptions = labelOptions(
        style = list("font-size" = "14px"),
        direction = "auto"
      )
    ) %>%
    addFullscreenControl(pseudoFullscreen = TRUE, position = "topright")

# Display the map
map_output


```

*In rot = Schulen mit Auswahl nach Noten. In Grün = Scholen ohne Noten. In schwarz = Keine Daten*

## Ziel
Diese Seite versucht die  Noten auf einer Karte darzustellen, die über Fragdenstaat.de von den Schulämtern bereit gestellt wurden. Weitere Informationen zu den Schulen siehe: [https://www.bildung.berlin.de/Schulverzeichnis/](https://www.bildung.berlin.de/Schulverzeichnis/)

## Erläuterung
Die Sekundarschulen in Berlin (Gymnasium, Integrierte Sekundarschule, Gemeinschaftsschule) haben Aufnahmekritierien für die Aufnahme von Kindern ab Jahrgangsstufe 7. 

Dabei werden die folgenden Kriterien angewendet 

1. Härtefälle 
2. die Auswahlkriterien der Schule 
3. den Losentscheid. 
 
Die Auswahlkriterien der Schule beinhalten eine Durchschnittsnote des Kindes aus den Halbjahren 2 der 5. Klasse und Halbjahr 1 der 6. Klasse (Durchschnittsnoten). Um eine Auswahl der Schule zu treffen muss der Notenschnitt der Schule bekannt sein, damit man weiß ob die Schule für die Schülerin/den Schüler realistisch ist. 

## Haftungsausschluss
Es kann keine Haftung übernommen werden. Bitte alle Daten kontrollieren!<br>

## Datenquelle
* Lichtenberg 2023: <a href="https://fragdenstaat.de/a/297001">Schulamt über Fragdenstaat.de</a><br>
* Lichtenberg 2025: <a href="https://fragdenstaat.de/a/352602">Schulamt über Fragdenstaat.de</a><br>
* Pankow 2023: <a href="https://fragdenstaat.de/a/296999">Schulamt über Fragdenstaat.de</a><br>
* Pankow 2024/25: <a href="https://fragdenstaat.de/a/354681">Schulamt über Fragdenstaat.de</a><br>

## Unterstützen
* Es fehlen die Daten aus Lichtenberg aus 2024. Wer mag gerne beim Schulamt Lichtenberg anfragen. Am besten per Fragdenstaat.de dann können die Noten von dort leicht übernommen werden.

## Danksagung
* Die Mitarbeitenden in den Ämtern
* Die Softwareprojekte R, RMarkdown, Leaflet
* Openstreetmap
* Mistral AI 