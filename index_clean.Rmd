---
title: "Schulnoten in Pankow und Lichtenberg"
html_document:
    css: ["styles.css"] 
---

```{r, warning=FALSE, message=FALSE, echo=FALSE, out.width="100%"}

# Read in data ------------------------------------------------------------

source("get_data.R")

# Load consolidated data from CSV
school_data <- get_school_data()

# Create summary data for visualization
school_summary <- create_school_summary(school_data)

# Get map data
schulen <- get_school_mapdata() |>
  dplyr::rename(lon = X, lat = Y) |>
  dplyr::filter(schultyp %in% c("Integrierte Sekundarschule", "Gymnasium"))

# First, add schul_nr to the map data by matching on name and bezirk
schul_nr_reference <- school_data |>
  dplyr::select(name, bezirk, schul_nr) |>
  dplyr::distinct()

schulen_with_ids <- schulen |>
  dplyr::left_join(schul_nr_reference, by = c("name", "bezirk"))

# Now join with school summary using schul_nr for more reliable matching
df <- schulen_with_ids |>
  dplyr::filter(bezirk == "Pankow" | bezirk == "Lichtenberg") |>
  dplyr::select(name, schultyp, bezirk, website, lon, lat, schul_nr) |>
  dplyr::left_join(school_summary, by = c("schul_nr", "bezirk")) |>
  dplyr::mutate(gruppe = "note-vorhanden") |>
  dplyr::mutate(gruppe = ifelse(latest_note == "ohne Note", "ohne-note", gruppe)) |>
  dplyr::mutate(gruppe = ifelse(is.na(latest_note), "keine-daten", gruppe)) |>
  dplyr::mutate(note_years = ifelse(is.na(note_years), "keine Daten", note_years))

# Setup leaflet -----------------------------------------------------------

pal <- leaflet::colorFactor(c('black', 'darkred', 'darkgreen'),
                            domain = c("note-vorhanden", "ohne-note", "keine-daten"))

# Start leaflet -----------------------------------------------------------

# Create enhanced labels with HTML
create_label <- function(name, website, note_years) {
  label_parts <- c(paste0("<b>", name, "</b>"))

  if (!is.na(website) && website != "") {
    label_parts <- c(label_parts, paste0('<a href="', website, '" target="_blank">Website</a>'))
  }

  label_parts <- c(label_parts, paste0("Noten: ", note_years))

  htmltools::HTML(paste(label_parts, collapse = "<br/>"))
}

# Apply labels to each school
popup_label <- vector("list", nrow(df))
for (i in seq_along(popup_label)) {
  popup_label[[i]] <- create_label(df$name[i], df$website[i], df$note_years[i])
}
df$popup_label <- popup_label

# Output the map and legend separately
# First, create and display the map
map_output <- 
  leaflet::leaflet(options = leaflet::leafletOptions(
    zoomControl = TRUE,
    attributionControl = TRUE,
    preferCanvas = TRUE,
    keyboard = TRUE,
    tap = TRUE,
    accessibility = TRUE,
    fadeAnimation = TRUE,
    zoomAnimation = TRUE
  )) |>
    leaflet::addTiles(
      attribution = 'Kartendaten &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende',
      options = leaflet::tileOptions(
        minZoom = 10,
        maxZoom = 18,
        detectRetina = TRUE
      )
    ) |>
    leaflet::setView(lng = 13.48, lat = 52.56, zoom = 12) |>
    leaflet::addCircleMarkers(
      lng = df$lon,
      lat = df$lat,
      color = pal(df$gruppe),
      radius = 8,
      stroke = FALSE,
      fillOpacity = 0.8,
      popup = df$popup_label,
      label = df$name,
      labelOptions = leaflet::labelOptions(
        style = list("font-size" = "14px", "font-weight" = "bold"),
        direction = "auto",
        noHide = TRUE,
        textOnly = TRUE
      ),
      options = leaflet::markerOptions(
        alt = paste(df$name, " - Schulnoten:", df$latest_note),
        title = paste(df$name, "(", df$bezirk, ")")
      )
    ) |>
    leaflet.extras::addFullscreenControl(pseudoFullscreen = TRUE, position = "topright") |>
    leaflet::addScaleBar(position = "bottomleft")

# Try to add help button if leaflet.extras is available
tryCatch({
  map_output <- map_output |>
    leaflet.extras::addEasyButton(
      leaflet.extras::easyButton(
        icon = "fa-info-circle",
        title = "Hilfe anzeigen",
        onClick = htmlwidgets::JS("alert('Klicken Sie auf eine Schulmarke für Details. Nutzen Sie die +/- Buttons zum Zoomen.')")
      )
    )
}, error = function(e) {
  message("leaflet.extras nicht verfügbar - Hilfe-Button wird nicht angezeigt")
})

# Display the map
map_output

```

<!-- Skip link for keyboard users -->
<a href="#main-content" class="skip-link">Direkt zum Inhalt springen</a>

<div id="main-content"></div>

*In rot = Schulen mit Auswahl nach Noten. In Grün = Scholen ohne Noten. In schwarz = Keine Daten*

## Ziel
Diese Seite versucht die  Noten auf einer Karte darzustellen, die über Fragdenstaat.de von den Schulämtern bereit gestellt wurden. Weitere Informationen zu den Schulen siehe: [https://www.bildung.berlin.de/Schulverzeichnis/](https://www.bildung.berlin.de/Schulverzeichnis/)

## Erläuterung
Die Sekundarschulen in Berlin (Gymnasium, Integrierte Sekundarschule, Gemeinschaftsschule) haben Aufnahmekritierien für die Aufnahme von Kindern ab Jahrgangsstufe 7. 

Dabei werden die folgenden Kriterien angewendet 

1. Härtefälle 
2. die Auswahlkriterien der Schule 
3. den Losentscheid. 
 
Die Auswahlkriterien der Schule beinhalten eine Durchschnittsnote des Kindes aus den Halbjahren 2 der 5. Klasse und Halbjahr 1 der 6. Klasse (Durchschnittsnoten). Um eine Auswahl der Schule zu treffen muss der Notenschnitt der Schule bekannt sein, damit man weiß ob die Schule für die Schülerin/den Schüler realistisch ist. 

## Haftungsausschluss
Es kann keine Haftung übernommen werden. Bitte alle Daten kontrollieren!<br>

## Datenquelle
* Lichtenberg 2023: <a href="https://fragdenstaat.de/a/297001">Schulamt über Fragdenstaat.de</a><br>
* Lichtenberg 2024: <a href="https://fragdenstaat.de/a/352602">Schulamt über Fragdenstaat.de</a><br>
* Lichtenberg 2025: <a href="https://fragdenstaat.de/a/352602">Schulamt über Fragdenstaat.de</a><br>
* Pankow 2023: <a href="https://fragdenstaat.de/a/296999">Schulamt über Fragdenstaat.de</a><br>
* Pankow 2024/25: <a href="https://fragdenstaat.de/a/354681">Schulamt über Fragdenstaat.de</a><br>

## Unterstützen
* Es fehlen die Daten aus Lichtenberg aus 2024. Wer mag gerne beim Schulamt Lichtenberg anfragen. Am besten per Fragdenstaat.de dann können die Noten von dort leicht übernommen werden.

## Danksagung
* Die Mitarbeitenden in den Ämtern
* Die Softwareprojekte R, RMarkdown, Leaflet
* Openstreetmap
* Mistral AI 
